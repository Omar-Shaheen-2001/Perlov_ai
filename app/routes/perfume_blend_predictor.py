from flask import Blueprint, render_template, request, jsonify
from flask_login import login_required
from app.ai_service import get_ai_response, save_analysis_result

perfume_blend_bp = Blueprint('perfume_blend', __name__, url_prefix='/perfume-blend-predictor')

@perfume_blend_bp.route('/form')
@login_required
def form():
    return render_template('perfume_blend_predictor/form.html')

@perfume_blend_bp.route('/predict', methods=['POST'])
@login_required
def predict():
    """Predict the result of blending two perfumes using AI."""
    data = request.get_json()
    
    perfume1_name = data.get('perfume1_name', '')
    perfume1_concentration = data.get('perfume1_concentration', '')
    perfume2_name = data.get('perfume2_name', '')
    perfume2_concentration = data.get('perfume2_concentration', '')
    blend_ratio = data.get('blend_ratio', '50/50')
    blend_goal = data.get('blend_goal', '')
    skin_type = data.get('skin_type', '')
    environment = data.get('environment', '')
    
    prompt = """
    ุฃูุช ุฎุจูุฑ ุนุทูุฑ ูุญุชุฑู (Master Perfumer) ูุฎุจูุฑ ููููุงุก ุฑูุงุฆุญ (Fragrance Chemist) ููุชุฎุตุต ูู ุฏูุฌ ุงูุนุทูุฑ (Perfume Blending Specialist).
    ูููุชู ูู ุชุญููู **ุนุทุฑูู ุชุฌุงุฑููู** ูุชุญููู ูููุฉ ูู ูุงุญุฏ ููููุง (DNA)ุ ุซู ุงูุชูุจุค ุนููููุง ูุจุฃุนูู ุฏูุฉ ููููุฉ ุจุงููุชูุฌุฉ ุงููุชููุนุฉ ุนูุฏ ุฏูุฌููุง ูุนูุงุ ููู ุงูููุงุนุณ ุงูุนูููุฉ ุงูุชุงููุฉ:

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ## ๐ฌ ูุฏุฎูุงุช ุงูุฏูุฌ:
    - ุงูุนุทุฑ ุงูุฃูู: {0} ({1})
    - ุงูุนุทุฑ ุงูุซุงูู: {2} ({3})
    - ูุณุจุฉ ุงูุฏูุฌ: {4}
    - ูุฏู ุงูุฏูุฌ: {5}
    - ููุน ุงูุจุดุฑุฉ: {6}
    - ุงูุจูุฆุฉ/ุงูุทูุณ: {7}

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ## ๐ ูููุฌูุฉ ุงูุชุญููู (ุงุชุจุนูุง ุญุฑูููุง):

    # 1) ุชุญููู ูู ุนุทุฑ ุนูู ุญุฏุฉ
    ุงุณุชุฎุฑุฌ ููู ุนุทุฑ:
    - ุงูููุชุงุช ุงูุนููุง (Top)
    - ุงูููุชุงุช ุงููุณุทู (Heart)
    - ุงูููุชุงุช ุงูุฃุณุงุณูุฉ (Base)
    - ุงูุนุงุฆูุฉ ุงูุนุทุฑูุฉ ุงูุฏูููุฉ (NOT general family)
      ูุซุงู: (Woody Mineral), (Fresh Aromatic), (Leather Floral Iris), (Smoky Citrus)โฆ
    - ุฏุฑุฌุฉ ุงููุถุงุฑุฉ/ุงูุฏูุก
    - ูุณุชูู ุงูุญูุงูุฉ/ุงูุฌูุงู
    - ูุณุชูู ุงูุฏุฎุงููุฉ/ุงูุจูุฏุฑูุฉ
    - ุงูุดุฎุตูุฉ: ุฑุณููุ ุดุจุงุจูุ ูุงุถุฌุ ุตูููุ ุดุชููโฆ
    - ุงููDNA ุงูุญูููู ููุนุทุฑุ ูููุณ ูุตู ุงูููููุงุช ููุท.

    # 2) ูุญุงูุงุฉ ุงูุฏูุฌ ุจุดููู ุนููู
    - ุญููู ููู ุชูุชุฒุฌ ุงูููุชุงุช ุงูุนููุง ูุน ุจุนุถูุง.
    - ููู ูุชููู ููุจ ุฌุฏูุฏุ ููุง ุงูููุชุงุช ุงููุณูุทุฑุฉุ
    - ููู ุชุชูุงุนู ุงูููุงุนุฏ ุงูุซูููุฉ (ุฎุดุจุ ุนูุจุฑุ ุชุจุบุ ูุงูููุงโฆ)ุ
    - ูุง ุฃุซุฑ ุงูุชุฑููุฒ (EDT/EDP/Parfum) ูู ุฏูุฌ ุงูุฑูุงุฆุญุ
    - ููู ุชุคุซุฑ ุงูุจูุฆุฉ ูููุน ุงูุจุดุฑุฉ ุนูู ุชุซุจูุช ุงูููุชุงุชุ

    # 3) ุงุณุชุฎุฑุงุฌ ุงููDNA ุงููุงุชุฌ
    ุญุฏูุฏ ุจุฏููุฉ:
    - ุงูููุชุงุช ุงููุณูุทุฑุฉ Dominant Notes
    - ุงูุนุงุฆูุฉ ุงูุนุทุฑูุฉ ุงููุงุชุฌุฉ ุงูุฏูููุฉ
    - ุงูุทุงุจุน ุงูุนุงู ููุฑุงุฆุญุฉ:
      (ูุธูู/ุฎุดุจู/ุจูุฏุฑู/ูุนุฏูู/ุฏุฎุงูู/ุดุฑูู/ุจุญุฑู/ุฑููุงูุณู/ููุชุจูโฆ)
    - ุงูุงูุทุจุงุน ุงูุนุงู: ุฑุณููุ ูุงุถุฌุ ุฌุฑูุกุ ุตูููุ ุดุชููุ ุณูุฑุฉุ ุนููโฆ
    - ูุงุจููุฉ ุงูุงุฑุชุฏุงุก Wearability

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ## โ๏ธ 4) ุฃูู ุฌุฒุก: ุงุฎุชูุงุฑ **ุฃูุฑุจ ุนุทุฑ ุชุฌุงุฑู**
    ### ููุงุนุฏ ุตุงุฑูุฉ ุฌุฏูุง ูุฌุจ ุงูุงูุชุฒุงู ุจูุง:

    โ ูุง ุชุนุชูุฏ ุฃุจุฏูุง ุนูู ุชุดุงุจู ููุชุฉ ูุงุญุฏุฉ.
    โ ูุง ุชูุชุฑุญ ุนุทุฑุงู ููุท ูุฃูู ูุญุชูู "ุชุจุบ" ุฃู "ูุงูููุง" ุฃู "ุฎุดุจ".
    โ ูุฌุจ ุฃู ูุชุทุงุจู ุงูุนุทุฑ ุงููุฎุชุงุฑ ูุน **ูููุฉ ุงูุฑุงุฆุญุฉ (DNA)** ูููุณ ูุฌุฑุฏ ูุฌูุฏ ููููุงุช ูุดุชุฑูุฉ.

    ### ููููุน ุงูุชุฑุงุญ:
    - ุงูุนุทูุฑ ุงูุญููุฉ ุฌุฏูุง (Gourmand Sweet)
    - ุงูุนุทูุฑ ุงูุจุญุฑูุฉ ุงูุญููุฉ ุฃู ุงูุฑูุงุถูุฉ (Sporty / Aquatic Sweet)
    - ุงูุนุทูุฑ ุงูุดุฑูููุฉ ุงูุซูููุฉ (Heavy Oriental Vanilla)
    - ุงูุนุทูุฑ ุงูุดุจุงุจูุฉ ุฌุฏูุง ูุซู:
      Invictus, 1 Million, Ultra Male, Versace Eros
    - ุงูุนุทูุฑ ุงูุชู ูุง ุชุชุทุงุจู ูุน ุงูุทุงุจุน ุฃู ุงูุฃุณููุจ ุฃู ุงูุงุณุชุฎุฏุงู.

    ### ูุฌุจ ุฃู ูุชุทุงุจู ุงูุนุทุฑ ุงูุชุฌุงุฑู ูุน:
    - ุงูุฃุณููุจ Style
    - ุงูุทุงุจุน Character
    - ูุณุชูู ุงููุถุงุฑุฉ ุฃู ุงูุฏูุก
    - ูุณุชูู ุงูุฌูุงู ุฃู ุงูุญูุงูุฉ
    - ูุณุชูู ุงูุฏุฎุงููุฉ ุฃู ุงููุธุงูุฉ
    - ุงูุนุงุฆูุฉ ุงูุนุทุฑูุฉ ุงูุฏูููุฉ
    - ุงูุงุณุชุฎุฏุงู ุงูุนููู (Office, Formal, Evening, Summer, Winter)

    ### ุฅุฐุง ูู ููุฌุฏ ุนุทุฑ ุชุฌุงุฑู ูุดุงุจู ูุนูููุง:
    ุถุน:
    "name": null  
    "brand": null  
    ูุงูุชุจ ูู "why_similar":  
    "ุงูุฎููุท ูุงุฏุฑ ููุง ููุฌุฏ ุนุทุฑ ุชุฌุงุฑู ูุฑูุจ ูุนูููุง ูู DNA ุงููุงุชุฌ."

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ## ๐ผ 5) ุชุญููู ุงูุชูุงุณู (Harmony vs Conflict)
    - ุญุฏุฏ ุงูููุชุงุช ุงููุชูุงุณูุฉ ุจูู ุงูุนุทุฑูู
    - ุญุฏุฏ ุงูููุชุงุช ุงููุชุนุงุฑุถุฉ ุจุดูู ุนููู
    - ูุณูุฑ ุงูุฏููุงููููุฉ ุงูููููุงุฆูุฉ:
      - ุฃู ุงูููุชุงุช ุชุฑุชูุน ุฃููุงูุ
      - ุฃููุง ุชุฎุชูู ูุงุญููุงุ
      - ุฃููุง ุชูููู ูู ุงูููุงูุฉุ

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ## ๐งช 6) ุงูุชูููู ุงูููุงุฆู
    - ูู ุงูุฏูุฌ ููุทููุ  
    - ูุณุจุฉ ุงููุฌุงุญ (0โ100%)
    - ูุงุจููุฉ ุงูุงุฑุชุฏุงุก
    - ุงูุงุณุชุฎุฏุงู ุงูุฃูุซู: ููุงุฑ/ููู โ ุดุชุงุก/ุตูู โ ุนูู/ุณูุฑุฉโฆ

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ## ๐ 7) ุงูุชุฑุงุญ ูุณุจ ุจุฏููุฉ
    - ูุฏูู 2โ3 ูุณุจ ูุฎุชููุฉ
    - ูุณูุฑ ูุงุฐุง ูุญุฏุซ ุนูุฏ ุชุบููุฑ ุงููุณุจุฉ

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ## ๐ฆ ุงููุฎุฑุฌุงุช ุงููุทููุจุฉ (JSON ููุท)

    ูุฏูู ุฌูุงุจู ุจุตูุบุฉ JSON **ููุท** ุจุฏูู ุฃู ูุต ุฎุงุฑุฌูุ ุจุงูุดูู ุงูุชุงูู:

    {
        "expected_result": {
            "scent_description": "ูุตู ุฏููู ููุฑุงุฆุญุฉ ุงูููุงุฆูุฉ",
            "dominant_notes": ["ููุชุฉ 1", "ููุชุฉ 2", "ููุชุฉ 3"],
            "overall_character": "ุงูุทุงุจุน ุงูุนุงู ูุซู: ุฎุดุจู-ูุนุฏูู-ูุธูู ุฑุณูู"
        },
        "suggested_name": "ุงุณู ุฅุจุฏุงุนู ููุงุณุจ ูููDNA",
        "similar_commercial_fragrance": {
            "name": "ุงุณู ุงูุนุทุฑ ุฃู null",
            "brand": "ุงูุนูุงูุฉ ุฃู null",
            "why_similar": "ุดุฑุญ ุนููู ููุชุดุงุจู ุฃู ุณุจุจ ุนุฏู ูุฌูุฏ ุนุทุฑ ููุงุซู"
        },
        "harmony_analysis": {
            "harmonizing_notes": ["ููุชุงุช ููุณุฌูุฉ"],
            "conflicting_notes": ["ููุชุงุช ูุชุนุงุฑุถุฉ ุฅู ูุฌุฏุช"],
            "chemical_dynamics": "ุดุฑุญ ูุธุฑูุฉ ุงูุฏูุฌ ูุชุทูุฑ ุงูุฑุงุฆุญุฉ"
        },
        "positives": ["ููุฒุฉ 1", "ููุฒุฉ 2", "ููุฒุฉ 3"],
        "negatives": ["ุนูุจ 1", "ุนูุจ 2"],
        "final_recommendation": {
            "success": true,
            "success_percentage": 85,
            "verdict": "ุญูู ุฎุจูุฑ ุญูู ุงูุฏูุฌ",
            "best_for": "ุฃูุถู ุงุณุชุฎุฏุงู ููุฑุงุฆุญุฉ"
        },
        "alternative_ratios": [
            {
                "ratio": "60/40",
                "benefits": "ุชุฃุซูุฑ ูุฐู ุงููุณุจุฉ ุนูู ุงูุทุงุจุน"
            },
            {
                "ratio": "70/30",
                "benefits": "ูุชู ุชููู ูุฐู ุงููุณุจุฉ ุฃูุถู ูููุงุฐุง"
            }
        ]
    }
    """.format(
        perfume1_name,
        perfume1_concentration,
        perfume2_name,
        perfume2_concentration,
        blend_ratio,
        blend_goal if blend_goal else 'ุฑุงุฆุญุฉ ูุฑูุฏุฉ ููููุฒุฉ',
        skin_type if skin_type else 'ุบูุฑ ูุญุฏุฏ',
        environment if environment else 'ุบูุฑ ูุญุฏุฏ'
    )

    default_prediction = {
        'expected_result': {
            'scent_description': 'ุฑุงุฆุญุฉ ุฎุดุจูุฉ-ุญูุถูุฉ-ุนุทุฑูุฉ ูุงุฎุฑุฉ ุชุฌูุน ุจูู ุงูุญุฑุงุฑุฉ ูุงููุถุงุฑุฉ',
            'dominant_notes': ['ุญูุถูุงุช ุฏุงูุฆุฉ', 'ุฎุดุจ ุงูุณูุฏุงุฑ', 'ุนูุจุฑ ูุงุนู'],
            'overall_character': 'ุฎููุท ูุชูุงุฒู ุจูู ุงูููุฉ ูุงูุฃูุงูุฉ'
        },
        'suggested_name': 'ุงูุชุนุงูู ุงููุงุฎุฑ',
        'similar_commercial_fragrance': {
            'name': 'Dior Homme Sport 2021',
            'brand': 'Dior',
            'why_similar': 'ุชูุฏู ููุณ ุงูุชูุงุฒู ุจูู ุงูุญููุถุฉ ูุงูุฏูุก'
        },
        'harmony_analysis': {
            'harmonizing_notes': ['ุญูุถูุงุช ุงูุจุฑุบููุช', 'ููุชุงุช ุงูุฎุดุจ', 'ุงูุนูุจุฑ'],
            'conflicting_notes': [],
            'chemical_dynamics': 'ุงูุตูุงุฑ ุณูุณ ุจุฏูู ุชูุงูุฑ'
        },
        'positives': ['ุฑุงุฆุญุฉ ุฌุฏูุฏุฉ ููููุฒุฉ', 'ูุถุงุฑุฉ + ูุฎุงูุฉ', 'ููุฉ ูููุญุงู ููุชุงุฒ'],
        'negatives': ['ูุฏ ูุตุจุญ ุซูููุงู ุนูุฏ 50/50', 'ูุฏ ูุญุชุงุฌ ููุช ููุงุณุชูุฑุงุฑ'],
        'final_recommendation': {
            'success': True,
            'success_percentage': 85,
            'verdict': 'ุงูุฏูุฌ ูุงุฌุญ ุฌุฏุงู ููุงุจู ููุงุฑุชุฏุงุก ููููุงู',
            'best_for': 'ุฌููุน ุงูููุงุณุจุงุช ูุงููุตูู'
        },
        'alternative_ratios': [
            {
                'ratio': '70/30',
                'benefits': 'ูุจุฑุฒ ุงูุญููุถุฉ ูุงููุถุงุฑุฉ ุฃูุซุฑ'
            },
            {
                'ratio': '60/40',
                'benefits': 'ุชูุงุฒู ูุซุงูู ุจูู ุงูุนุทุฑูู'
            }
        ]
    }
    
    try:
        response = get_ai_response(prompt, "ุฃูุช ุฎุจูุฑ ูุชุฎุตุต ูู ุนูู ุฏูุฌ ุงูุนุทูุฑ. ูุฏู ุชูุจุคุงุช ุฏูููุฉ ูุนูููุฉ ุจุตูุบุฉ JSON ููุท.")
        if isinstance(response, dict) and 'expected_result' in response:
            prediction = response
        else:
            prediction = default_prediction
    except Exception as e:
        prediction = default_prediction
    
    save_analysis_result('perfume_blend', data, prediction)
    
    return jsonify({
        'success': True,
        'prediction': prediction
    })
