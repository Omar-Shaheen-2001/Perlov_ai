from flask import Blueprint, render_template, request, jsonify
from flask_login import login_required
from app.ai_service import get_ai_response, save_analysis_result

perfume_blend_bp = Blueprint('perfume_blend', __name__, url_prefix='/perfume-blend-predictor')

@perfume_blend_bp.route('/form')
@login_required
def form():
    return render_template('perfume_blend_predictor/form.html')

@perfume_blend_bp.route('/predict', methods=['POST'])
@login_required
def predict():
    """Predict the result of blending two perfumes using AI."""
    data = request.get_json()
    
    perfume1_name = data.get('perfume1_name', '')
    perfume1_concentration = data.get('perfume1_concentration', '')
    perfume2_name = data.get('perfume2_name', '')
    perfume2_concentration = data.get('perfume2_concentration', '')
    blend_ratio = data.get('blend_ratio', '50/50')
    blend_goal = data.get('blend_goal', '')
    skin_type = data.get('skin_type', '')
    environment = data.get('environment', '')
    
    prompt = f"""
    ุฃูุช ุฎุจูุฑ ุนุทูุฑ ูุญุชุฑู (Master Perfumer)ุ ูุฎุจูุฑ ููููุงุก ุฑูุงุฆุญ (Fragrance Chemist)ุ
    ููุชุฎุตุต ูู ุชุญููู ุงููDNA ุงูุนุทุฑู ูุชุญุฏูุฏ ุงูุนุทูุฑ ุงูุฃูุซุฑ ุชุทุงุจููุง ูุนู (Perfume DNA Matching Specialist).

    ูููุชู ูู ุชุญููู **ุนุทุฑ ูุงุญุฏ ููุท** ููุฏูู ุงููุณุชุฎุฏู (ุณูุงุก ูุงู ูุตููุงุ ููููุงุชุ ุฅุญุณุงุณูุงุ ุฃู ุฃุฌูุงุก)ุ
    ูุงุณุชุฎุฑุงุฌ ุงููDNA ุงูุฎุงุต ุจู ุจุฏูุฉ ุนุงููุฉ ุฌุฏูุงุ ุซู ุงุฎุชูุงุฑ **ุฃูุฑุจ 3 ุนุทูุฑ ุชุฌุงุฑูุฉ** ุชุชุทุงุจู ูุน ุงููููุฉ
    ุงูุนุทุฑูุฉ (DNA) ูู ุญูุซ ุงูุฃุณููุจ ูุงูุทุงุจุนุ ูููุณ ูุฌุฑุฏ ุชุดุงุจู ูู ุงูููููุงุช.

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   ## ๐ฌ ูุฏุฎูุงุช ุงูุฏูุฌ:
- ุงูุนุทุฑ ุงูุฃูู: {perfume1_name} ({perfume1_concentration})
- ุงูุนุทุฑ ุงูุซุงูู: {perfume2_name} ({perfume2_concentration})
- ูุณุจุฉ ุงูุฏูุฌ: {blend_ratio}
- ูุฏู ุงูุฏูุฌ: {blend_goal if blend_goal else 'ุฑุงุฆุญุฉ ูุฑูุฏุฉ ููููุฒุฉ'}
- ููุน ุงูุจุดุฑุฉ: {skin_type if skin_type else 'ุบูุฑ ูุญุฏุฏ'}
- ุงูุจูุฆุฉ/ุงูุทูุณ: {environment if environment else 'ุบูุฑ ูุญุฏุฏ'}

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ## ๐ ูููุฌูุฉ ุงูุชุญููู (ุงุชุจุนูุง ุญุฑูููุง):

    # 1) ุชุญููู ุงููุตู ุจุฏูุฉ ุนุงููุฉ
    ุงุณุชุฎุฑุฌ ูู ูุตู ุงููุณุชุฎุฏู:
    - ุงูููุชุงุช ุงูุนููุง (Top Notes) ุฅู ุธูุฑุช
    - ุงูููุชุงุช ุงููุณุทู (Heart/Middle Notes)
    - ุงูููุชุงุช ุงูุฃุณุงุณูุฉ (Base Notes)
    - ุงูุนุงุฆูุฉ ุงูุนุทุฑูุฉ ุงูุฏูููุฉ (NOT general family)
      ุฃูุซูุฉ: Woody Mineral, Incense Woody, Fresh Aromatic, Leather Iris, Smoky Amber, Citrus Metallicโฆ
    - ุงูุทุงุจุน ุงูุนุงู (Character)
      ูุซู: ุฑุณููุ ูุงุถุฌุ ุดุจุงุจูุ ุญุณูุ ูุธููุ ุฏุฎุงููุ ุจูุฏุฑูุ ูุงูููโฆ
    - ุงูุฃุณููุจ (Style)
      ูุซู: Blue style, Oriental Clean, Minimalistic, Smoky Modern, Spicy Woodyโฆ
    - ุฏุฑุฌุฉ ุงูุญูุงูุฉ ุฃู ุงูุฌูุงู (Sweet vs Dry)
    - ูุณุชูู ุงููุถุงุฑุฉ ุฃู ุงูุฏูุก
    - ูุณุชูู ุงูุฏุฎุงููุฉ ุฃู ุงูุจูุฏุฑูุฉ ุฃู ุงูุฑุงุชูุฌูุฉ

    # 2) ุจูุงุก ุงููDNA ุงูุนุทุฑู ุงูููุงุฆู
    ุงุณุชุฎูุต ุจุตูุฉ ุงูุนุทุฑ (Scent DNA):
    - ุงูููุชุงุช ุงูุฃูุซุฑ ููููุฉ Dominant Notes
    - ุงูุฑูุญ ุงูุนุงูุฉ ููุนุทุฑ
    - ุงูุงูุทุจุงุน ูุงูุดุนูุฑ
    - ุงูุงุณุชุฎุฏุงู ุงูุฃูุซู (ููู/ููุงุฑ โ ุตูู/ุดุชุงุก โ ุนูู/ููุงุณุจุงุช)
    - ุดุฎุตูุฉ ุงูุนุทุฑ: ุฑุณููุ ุดุจุงุจูุ ุฌุฐุงุจุ ูุงุถุฌุ ูุงุฎุฑโฆ

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ## โ๏ธ 3) ุงุฎุชูุงุฑ **ุฃูุถู 3 ุนุทูุฑ ุชุฌุงุฑูุฉ** ูุชุทุงุจูุฉ
    ### ููุงุนุฏ ุตุงุฑูุฉ ุฌุฏูุง:

    โ ูุง ุชุนุชูุฏ ุฃุจุฏูุง ุนูู ุชุดุงุจู ููุชุฉ ูุงุญุฏุฉ.
    โ ูุง ุชุฐูุฑ ุนุทุฑูุง ูุฃูู ูุดููุฑ.
    โ ูุง ุชุฐูุฑ ุนุทุฑุงู ููุท ูุฃูู ูุญุชูู ูุงูููุง/ุชุจุบ/ุฎุดุจ ูุดุจู ูุง ูู ุงููุตู.

    โ ุงุฎุชุฑ ููุท ุงูุนุทูุฑ ุงูุชู ุชุดุชุฑู ูุน ุงููุตู ูู:
    - ุงูุทุงุจุน ุงูุนุงู (Character)
    - ุงูุฃุณููุจ (Style)
    - ุงููุธุงูุฉ/ุงูุฏูุก
    - ูุณุชูู ุงูุญูุงูุฉ/ุงูุฌูุงู
    - ูุณุชูู ุงูุฏุฎุงููุฉ ุฃู ุงูุจูุฏุฑูุฉ
    - ุงูุนุงุฆูุฉ ุงูุนุทุฑูุฉ ุงูุฏูููุฉ

    ### ูููุน ุงุฎุชูุงุฑ ุงูุนุทูุฑ ุงูุชุงููุฉ ุฅุฐุง ูู ุชุชูุงูู ูุน ุงููDNA:
    - ุงูุนุทูุฑ ุงูุณูุฑูุฉ ุฌุฏูุง (Gourmand)
    - ุงูุนุทูุฑ ุงูุจุญุฑูุฉ ุงูุญููุฉ ุฃู ุงูุฑูุงุถูุฉ (Invictus, Dylan Blue, Ultra Male)
    - ุงูุนุทูุฑ ุงูุดุฑููุฉ ุงูุซูููุฉ ุบูุฑ ุงูููุงุณุจุฉ
    - ุงูุนุทูุฑ ุงูุชู ูุง ุชุทุงุจู ุงูุฃุฌูุงุก ุงูุนุงูุฉ ูููุตู

    ### ุฅุฐุง ูุงู ุงูุนุทุฑ ูุงุฏุฑ ุงููDNA ููุง ููุฌุฏ ูุดุงุจู ุญูููู:
    ุถุน:
    "name": null
    "brand": null
    ููุณูุฑ ุงูุณุจุจ ูู "why_similar".

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ## ๐ฏ 4) ููู ุนุทุฑ ูู ุงูุซูุงุซุฉ ุงููุฎุชุงุฑุฉ ูุฏูู:
    - ุงูููุชุงุช ุงููุนููุฉ
    - ุงูุนุงุฆูุฉ ุงูุนุทุฑูุฉ
    - ุณุจุจ ุงูุชุทุงุจู ุจูุงุกู ุนูู 6 ุนูุงูู (NOT ingredients):
      1. ุงูุนุงุฆูุฉ ุงูุนุทุฑูุฉ
      2. ุงูุฃุณููุจ
      3. ุงูุทุงุจุน ุงูุนุงู
      4. ูุณุชูู ุงูุฏูุก/ุงููุถุงุฑุฉ
      5. ุฏุฑุฌุฉ ุงูุญูุงูุฉ/ุงูุฌูุงู
      6. ุงูุฃุฌูุงุก ูุงูุงุณุชุฎุฏุงู

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ## ๐ฆ ุงููุฎุฑุฌุงุช ุงููุทููุจุฉ (JSON ููุท):

    ูุฏูู ุฌูุงุจู ุจุตูุบุฉ JSON ููุทุ ุจุฏูู ุฃู ูุต ุขุฎุฑ:

    {{
        "extracted_DNA": {{
            "dominant_notes": ["ููุชุฉ 1", "ููุชุฉ 2"],
            "family": "ุงูุนุงุฆูุฉ ุงูุนุทุฑูุฉ ุงูุฏูููุฉ",
            "character": "ุฃุณููุจ ูุทุงุจุน ุงูุนุทุฑ",
            "usage": "ุฃูุถู ููุช/ููุณู/ููุงุณุจุฉ",
            "overall_impression": "ูุตู ุดุงูู ูุจุตูุฉ ุงูุนุทุฑ"
        }},
        "top_matches": [
            {{
                "name": "ุงูุนุทุฑ ุงูุฃูู",
                "brand": "ุงูุนูุงูุฉ",
                "match_percentage": 90,
                "why_similar": "ุดุฑุญ ุฏููู ูุนุชูุฏ ุนูู DNA ูููุณ ุงูููููุงุช ููุท"
            }},
            {{
                "name": "ุงูุนุทุฑ ุงูุซุงูู",
                "brand": "ุงูุนูุงูุฉ",
                "match_percentage": 87,
                "why_similar": "ุดุฑุญ ุฏููู"
            }},
            {{
                "name": "ุงูุนุทุฑ ุงูุซุงูุซ",
                "brand": "ุงูุนูุงูุฉ",
                "match_percentage": 85,
                "why_similar": "ุดุฑุญ ุฏููู"
            }}
        ]
    }}
    """

    default_prediction = {
        'expected_result': {
            'scent_description': 'ุฑุงุฆุญุฉ ุฎุดุจูุฉ-ุญูุถูุฉ-ุนุทุฑูุฉ ูุงุฎุฑุฉ ุชุฌูุน ุจูู ุงูุญุฑุงุฑุฉ ูุงููุถุงุฑุฉ',
            'dominant_notes': ['ุญูุถูุงุช ุฏุงูุฆุฉ', 'ุฎุดุจ ุงูุณูุฏุงุฑ', 'ุนูุจุฑ ูุงุนู'],
            'overall_character': 'ุฎููุท ูุชูุงุฒู ุจูู ุงูููุฉ ูุงูุฃูุงูุฉ'
        },
        'suggested_name': 'ุงูุชุนุงูู ุงููุงุฎุฑ',
        'similar_commercial_fragrance': {
            'name': 'Dior Homme Sport 2021',
            'brand': 'Dior',
            'why_similar': 'ุชูุฏู ููุณ ุงูุชูุงุฒู ุจูู ุงูุญููุถุฉ ูุงูุฏูุก'
        },
        'harmony_analysis': {
            'harmonizing_notes': ['ุญูุถูุงุช ุงูุจุฑุบููุช', 'ููุชุงุช ุงูุฎุดุจ', 'ุงูุนูุจุฑ'],
            'conflicting_notes': [],
            'chemical_dynamics': 'ุงูุตูุงุฑ ุณูุณ ุจุฏูู ุชูุงูุฑ'
        },
        'positives': ['ุฑุงุฆุญุฉ ุฌุฏูุฏุฉ ููููุฒุฉ', 'ูุถุงุฑุฉ + ูุฎุงูุฉ', 'ููุฉ ูููุญุงู ููุชุงุฒ'],
        'negatives': ['ูุฏ ูุตุจุญ ุซูููุงู ุนูุฏ 50/50', 'ูุฏ ูุญุชุงุฌ ููุช ููุงุณุชูุฑุงุฑ'],
        'final_recommendation': {
            'success': True,
            'success_percentage': 85,
            'verdict': 'ุงูุฏูุฌ ูุงุฌุญ ุฌุฏุงู ููุงุจู ููุงุฑุชุฏุงุก ููููุงู',
            'best_for': 'ุฌููุน ุงูููุงุณุจุงุช ูุงููุตูู'
        },
        'alternative_ratios': [
            {
                'ratio': '70/30',
                'benefits': 'ูุจุฑุฒ ุงูุญููุถุฉ ูุงููุถุงุฑุฉ ุฃูุซุฑ'
            },
            {
                'ratio': '60/40',
                'benefits': 'ุชูุงุฒู ูุซุงูู ุจูู ุงูุนุทุฑูู'
            }
        ]
    }
    
    try:
        response = get_ai_response(prompt, "ุฃูุช ุฎุจูุฑ ูุชุฎุตุต ูู ุนูู ุฏูุฌ ุงูุนุทูุฑ. ูุฏู ุชูุจุคุงุช ุฏูููุฉ ูุนูููุฉ ุจุตูุบุฉ JSON ููุท.")
        if isinstance(response, dict) and 'expected_result' in response:
            prediction = response
        else:
            prediction = default_prediction
    except:
        prediction = default_prediction
    
    save_analysis_result('perfume_blend', data, prediction)
    
    return jsonify({
        'success': True,
        'prediction': prediction
    })
