{% extends "base.html" %}

{% block title %}Bio-Scent AI - ูุญูู ุงูุฅุดุงุฑุงุช ุงูุญูููุฉ{% endblock %}

{% block content %}
<div class="page-header text-center">
    <div class="container">
        <h1>Bio-Scent AI</h1>
        <p class="opacity-75">ูุญูู ุงูุฅุดุงุฑุงุช ุงูุญูููุฉ - ุงูุชุดู ุนุทุฑู ูู ุฎูุงู ุญูููุชู</p>
    </div>
</div>

<div class="container py-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow-sm rounded-4 border-0" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);">
                <div class="card-body p-4">
                    
                    <!-- ุงููุฏุฎูุงุช -->
                    <div id="inputs-section">
                        <h2 class="fw-bold mb-4 text-center">ูุฏุฎูุงุช ุงูุชุญููู</h2>
                        
                        <form id="bioScent-form">
                            <!-- ุงูุญุงูุฉ ุงููุฒุงุฌูุฉ -->
                            <div class="mb-4">
                                <label for="mood" class="form-label fw-bold">
                                    <i class="bi bi-emoji-smile me-2"></i>ุงูุญุงูุฉ ุงููุฒุงุฌูุฉ
                                </label>
                                <select class="form-select rounded-3 form-select-lg" id="mood" name="mood" required>
                                    <option value="">ุงุฎุชุฑ ุญุงูุชู ุงููุฒุงุฌูุฉ</option>
                                    <option value="ุณุนูุฏ">ุณุนูุฏ ๐</option>
                                    <option value="ูุงุฏุฆ">ูุงุฏุฆ ๐</option>
                                    <option value="ูุดูุท">ูุดูุท โก</option>
                                    <option value="ุญุฒูู">ุญุฒูู ๐ข</option>
                                    <option value="ูุงุฏู">ูุงุฏู ๐ด</option>
                                    <option value="ูุชุญูุณ">ูุชุญูุณ ๐</option>
                                </select>
                            </div>

                            <!-- ุชุณุฌูู ุงูุตูุช -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-mic me-2"></i>ุชุณุฌูู ุตูุช ูุตูุฑ (10-30 ุซุงููุฉ)
                                </label>
                                
                                <!-- ููุทูุฉ ุงูุชุณุฌูู -->
                                <div class="card rounded-3 border-0 p-3" style="background: rgba(79, 125, 255, 0.1);">
                                    <div class="text-center mb-3">
                                        <div id="recording-status" class="mb-2">
                                            <span id="recording-indicator" class="badge bg-danger d-none">
                                                <i class="bi bi-circle-fill me-1"></i>ุฌุงุฑู ุงูุชุณุฌูู
                                            </span>
                                        </div>
                                        <div id="timer" style="font-size: 1.5rem; font-weight: bold; color: #0B2E8A;">00:00</div>
                                    </div>

                                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                                        <button type="button" class="btn btn-danger rounded-pill" id="record-btn">
                                            <i class="bi bi-circle-fill me-2"></i>ุงุจุฏุฃ ุงูุชุณุฌูู
                                        </button>
                                        <button type="button" class="btn btn-secondary rounded-pill d-none" id="stop-btn">
                                            <i class="bi bi-stop-fill me-2"></i>ุฅููุงู ุงูุชุณุฌูู
                                        </button>
                                        <button type="button" class="btn btn-outline-primary rounded-pill d-none" id="play-btn">
                                            <i class="bi bi-play-fill me-2"></i>ุงุณุชูุน
                                        </button>
                                        <button type="button" class="btn btn-outline-danger rounded-pill d-none" id="clear-btn">
                                            <i class="bi bi-trash me-2"></i>ุญุฐู
                                        </button>
                                    </div>

                                    <div id="recording-info" class="text-center mt-3 text-muted d-none">
                                        <small><i class="bi bi-check-circle-fill text-success me-1"></i>ุชู ุชุณุฌูู ุตูุชู ุจูุฌุงุญ</small>
                                    </div>
                                </div>

                                <audio id="audio-player" class="w-100 mt-3 d-none"></audio>
                                <input type="hidden" id="audio-data" name="audio_data">
                                
                                <small class="text-muted d-block mt-2">ุชุฌูุจ ุงูุฃุตูุงุช ุงูุฎูููุฉ - ุณูุชู ุชุญููู ูุจุฑุฉ ุตูุชู ูุณุฑุนุฉ ููุงูู</small>
                            </div>

                            <!-- ุตูุฑุฉ ุงูุจุดุฑุฉ -->
                            <div class="mb-4">
                                <label for="skin-image" class="form-label fw-bold">
                                    <i class="bi bi-image me-2"></i>ุตูุฑุฉ ุงููุฌู / ุงูุจุดุฑุฉ
                                </label>
                                <div class="input-group input-group-lg">
                                    <input type="file" class="form-control rounded-3" id="skin-image" accept="image/*" placeholder="ุงุฎุชุฑ ุตูุฑุฉ">
                                </div>
                                <small class="text-muted d-block mt-2">ุณุชุณุงุนุฏูุง ูุชุญุฏูุฏ ููุน ุจุดุฑุชู ูุญุณุงุณูุชูุง</small>
                            </div>

                            <!-- ุณุฑุนุฉ ุงูููุงู -->
                            <div class="mb-4">
                                <label for="speech-speed" class="form-label fw-bold">
                                    <i class="bi bi-speedometer2 me-2"></i>ุณุฑุนุฉ ุงูููุงู ุงููุชููุนุฉ
                                </label>
                                <select class="form-select rounded-3 form-select-lg" id="speech-speed" name="speech_speed">
                                    <option value="ุจุทูุก">ุจุทูุก ุฌุฏุงู</option>
                                    <option value="ูุนุชุฏู" selected>ูุนุชุฏู</option>
                                    <option value="ุณุฑูุน">ุณุฑูุน</option>
                                    <option value="ุณุฑูุน ุฌุฏุงู">ุณุฑูุน ุฌุฏุงู</option>
                                </select>
                                <small class="text-muted d-block mt-2">ูุฐุง ูุณุงุนุฏูุง ุนูู ููู ุทุงูุชู ุงูุดุฎุตูุฉ</small>
                            </div>

                            <!-- ุฒุฑ ุงูุชุญููู -->
                            <div class="text-center">
                                <button type="button" class="btn btn-gradient btn-lg rounded-pill px-5" id="analyze-btn">
                                    <i class="bi bi-play-circle me-2"></i>ุงุจุฏุฃ ุงูุชุญููู ุงูุญููู
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- ุงููุชุงุฆุฌ -->
                    <div id="results-section" class="d-none">
                        <h2 class="fw-bold mb-4 text-center">ูุชุงุฆุฌ ุงูุชุญููู</h2>
                        
                        <!-- ุชุญููู ุงูุตูุช -->
                        <div class="mb-4">
                            <div class="card rounded-4 border-0" style="background: linear-gradient(135deg, rgba(11, 46, 138, 0.3) 0%, rgba(242, 244, 248, 0.3) 100%);">
                                <div class="card-body">
                                    <h5 class="fw-bold mb-3">
                                        <i class="bi bi-waveform text-primary me-2"></i>ุชุญููู ุงูุตูุช
                                    </h5>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>ุงููุฒุงุฌ ุงูููุชุดู:</strong> <span id="detected-mood">-</span></li>
                                        <li class="mb-2"><strong>ูุจุฑุฉ ุงูุตูุช:</strong> <span id="voice-tone">ุฏุงูุฆุฉ ููุงุฏุฆุฉ</span></li>
                                        <li class="mb-2"><strong>ุณุฑุนุฉ ุงูููุงู:</strong> <span id="detected-speed">-</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- ุชุญููู ุงูุจุดุฑุฉ -->
                        <div class="mb-4">
                            <div class="card rounded-4 border-0" style="background: linear-gradient(135deg, rgba(79, 125, 255, 0.3) 0%, rgba(242, 244, 248, 0.3) 100%);">
                                <div class="card-body">
                                    <h5 class="fw-bold mb-3">
                                        <i class="bi bi-heart-fill text-info me-2"></i>ุชุญููู ุงูุจุดุฑุฉ
                                    </h5>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>ููุน ุงูุจุดุฑุฉ:</strong> <span id="skin-type">-</span></li>
                                        <li class="mb-2"><strong>ุฏุฑุฌุฉ ุงูุญุณุงุณูุฉ:</strong> <span id="skin-sensitivity">ูุชูุณุทุฉ</span></li>
                                        <li class="mb-2"><strong>ุงูุชูุตูุงุช:</strong> <span id="skin-rec">ุชุฌูุจ ุงููุญูู ุงูุนุงูู</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- ุชููุนุงุช ุงูุฐูู ุงูุนุทุฑู -->
                        <div class="mb-4">
                            <div class="card rounded-4 border-0" style="background: linear-gradient(135deg, rgba(11, 46, 138, 0.3) 0%, rgba(11, 46, 138, 0.15) 100%);">
                                <div class="card-body">
                                    <h5 class="fw-bold mb-3">
                                        <i class="bi bi-star-fill text-primary me-2"></i>ุชููุนุงุช ุงูุฐูู ุงูุนุทุฑู
                                    </h5>
                                    <div id="fragrance-predictions">
                                        <p class="text-muted">ุฌุงุฑู ุงูุชุญููู...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ุชูุตูุงุช ุญุณุงุณุฉ ุงูุจุดุฑุฉ -->
                        <div class="mb-4">
                            <div class="card rounded-4 border-0" style="background: linear-gradient(135deg, rgba(52, 211, 153, 0.15) 0%, rgba(167, 243, 208, 0.15) 100%);">
                                <div class="card-body">
                                    <h5 class="fw-bold mb-3">
                                        <i class="bi bi-shield-check text-success me-2"></i>ุชูุตูุงุช ุญุณุงุณุฉ ููุจุดุฑุฉ
                                    </h5>
                                    <p id="sensitive-recommendations" class="text-muted mb-0">
                                        -
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- ููุชุฑุญุงุช ุนุทูุฑ ุฐููุฉ -->
                        <div class="mb-4">
                            <div class="card rounded-4 border-0" style="background: linear-gradient(135deg, rgba(79, 125, 255, 0.15) 0%, rgba(11, 46, 138, 0.1) 100%);">
                                <div class="card-body">
                                    <h5 class="fw-bold mb-3">
                                        <i class="bi bi-sparkles text-primary me-2"></i>ููุชุฑุญุงุช ุนุทูุฑ ูุฎุตุตุฉ ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
                                    </h5>
                                    <div id="ai-suggestions" style="max-height: 500px; overflow-y: auto;">
                                        <div class="text-center text-muted">
                                            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                            ุฌุงุฑู ุชุญููู ูููู ูุงูุญุตูู ุนูู ููุชุฑุญุงุช ุดุฎุตูุฉ...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ุฒุฑ ุงูุนูุฏุฉ -->
                        <div class="text-center mt-4">
                            <button type="button" class="btn btn-outline-primary btn-lg rounded-pill px-5" id="back-btn">
                                <i class="bi bi-arrow-left me-2"></i>ุฅุนุงุฏุฉ ุงูุชุญููู
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Audio Recording Setup
let mediaRecorder;
let recordedChunks = [];
let recordingStartTime;
let timerInterval;
let isRecording = false;

// Initialize Recording
async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            recordedChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.onloadend = () => {
                document.getElementById('audio-data').value = reader.result;
            };
            reader.readAsDataURL(audioBlob);
            
            const audioUrl = URL.createObjectURL(audioBlob);
            const player = document.getElementById('audio-player');
            player.src = audioUrl;
            player.classList.remove('d-none');
        };
        
        mediaRecorder.start();
        isRecording = true;
        recordingStartTime = Date.now();
        
        // Update UI
        document.getElementById('record-btn').classList.add('d-none');
        document.getElementById('stop-btn').classList.remove('d-none');
        document.getElementById('recording-indicator').classList.remove('d-none');
        document.getElementById('recording-info').classList.add('d-none');
        
        // Start Timer
        timerInterval = setInterval(updateTimer, 100);
        
    } catch (err) {
        showError('ูุง ูููู ุงููุตูู ุฅูู ุงููููุฑูููู. ูุฑุฌู ุงูุณูุงุญ ุจุงููุตูู.');
    }
}

function stopRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        isRecording = false;
        
        clearInterval(timerInterval);
        
        // Update UI
        document.getElementById('stop-btn').classList.add('d-none');
        document.getElementById('record-btn').classList.remove('d-none');
        document.getElementById('play-btn').classList.remove('d-none');
        document.getElementById('clear-btn').classList.remove('d-none');
        document.getElementById('recording-indicator').classList.add('d-none');
        document.getElementById('recording-info').classList.remove('d-none');
        document.getElementById('timer').textContent = '00:00';
    }
}

function updateTimer() {
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    const mins = Math.floor(elapsed / 60);
    const secs = elapsed % 60;
    document.getElementById('timer').textContent = 
        `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
}

function playRecording() {
    const player = document.getElementById('audio-player');
    if (player.paused) {
        player.play();
        document.getElementById('play-btn').innerHTML = '<i class="bi bi-pause-fill me-2"></i>ุฅููุงู';
    } else {
        player.pause();
        document.getElementById('play-btn').innerHTML = '<i class="bi bi-play-fill me-2"></i>ุงุณุชูุน';
    }
}

function clearRecording() {
    document.getElementById('audio-data').value = '';
    document.getElementById('audio-player').src = '';
    document.getElementById('audio-player').classList.add('d-none');
    document.getElementById('play-btn').classList.add('d-none');
    document.getElementById('clear-btn').classList.add('d-none');
    document.getElementById('recording-info').classList.add('d-none');
    document.getElementById('record-btn').classList.remove('d-none');
    recordedChunks = [];
}

// Event Listeners
document.getElementById('record-btn').addEventListener('click', startRecording);
document.getElementById('stop-btn').addEventListener('click', stopRecording);
document.getElementById('play-btn').addEventListener('click', playRecording);
document.getElementById('clear-btn').addEventListener('click', clearRecording);

// Analyze Button
document.getElementById('analyze-btn').addEventListener('click', function() {
    const btn = this;
    const mood = document.getElementById('mood').value;
    const speechSpeed = document.getElementById('speech-speed').value;
    const audioData = document.getElementById('audio-data').value;
    
    if (!mood) {
        showError('ูู ูุถูู ุงุฎุชุฑ ุญุงูุชู ุงููุฒุงุฌูุฉ');
        return;
    }
    
    showLoading(btn);
    fetch('{{ url_for("bio_scent.analyze") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mood: mood,
            speech_speed: speechSpeed,
            skin_type: 'ูุนุชุฏูุฉ',
            audio_data: audioData
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading(btn);
        document.getElementById('detected-mood').textContent = mood;
        document.getElementById('detected-speed').textContent = speechSpeed;
        document.getElementById('skin-type').textContent = data.skin_analysis.skin_type;
        
        const predictions = data.fragrance_predictions.map((pred, idx) => {
            return `<div class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>${pred}</div>`;
        }).join('');
        document.getElementById('fragrance-predictions').innerHTML = predictions;
        
        document.getElementById('sensitive-recommendations').textContent = data.sensitive_recommendations;
        
        document.getElementById('inputs-section').classList.add('d-none');
        document.getElementById('results-section').classList.remove('d-none');
        showSuccess('ุชู ุงูุชุญููู ุงูุญููู ุจูุฌุงุญ!');
        
        // Get AI suggestions
        fetchAISuggestions(mood, speechSpeed, data.fragrance_predictions);
    })
    .catch(err => {
        hideLoading(btn);
        showError('ุญุฏุซ ุฎุทุฃุ ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู');
    });
});

document.getElementById('back-btn').addEventListener('click', function() {
    document.getElementById('results-section').classList.add('d-none');
    document.getElementById('inputs-section').classList.remove('d-none');
    document.getElementById('bioScent-form').reset();
    clearRecording();
});

// Fetch AI Suggestions
function fetchAISuggestions(mood, speechSpeed, predictions) {
    fetch('{{ url_for("bio_scent.get_suggestions") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mood: mood,
            speech_speed: speechSpeed,
            skin_type: 'ูุนุชุฏูุฉ',
            fragrance_predictions: predictions
        })
    })
    .then(response => response.json())
    .then(data => {
        const suggestionsContainer = document.getElementById('ai-suggestions');
        
        if (!data.suggestions || data.suggestions.length === 0) {
            suggestionsContainer.innerHTML = '<p class="text-muted text-center">ูู ูุชู ุงูุนุซูุฑ ุนูู ููุชุฑุญุงุช</p>';
            return;
        }
        
        let html = `
            <div class="mb-3">
                <p class="text-muted mb-3"><i class="bi bi-quote me-2"></i><em>${data.personalized_advice || 'ููุชุฑุญุงุช ุดุฎุตูุฉ ุจูุงุกู ุนูู ุชุญูููู'}</em></p>
            </div>
        `;
        
        data.suggestions.forEach((suggestion, idx) => {
            html += `
                <div class="card rounded-3 border-0 mb-3" style="background: linear-gradient(135deg, rgba(79, 125, 255, 0.08) 0%, rgba(242, 244, 248, 0.1) 100%);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="fw-bold mb-1">${idx + 1}. ${suggestion.name}</h6>
                                <p class="text-muted mb-2" style="font-size: 0.9rem;">${suggestion.brand}</p>
                            </div>
                            <span class="badge bg-primary rounded-pill" style="background: linear-gradient(135deg, #0B2E8A 0%, #4F7DFF 100%) !important;">${suggestion.match_percentage}%</span>
                        </div>
                        
                        <p class="mb-2" style="font-size: 0.95rem;">
                            <i class="bi bi-info-circle text-primary me-1"></i>
                            <strong>ุงูุณุจุจ:</strong> ${suggestion.reason}
                        </p>
                        
                        <p class="mb-2" style="font-size: 0.9rem;">
                            <i class="bi bi-droplet text-info me-1"></i>
                            <strong>ุงูููุชุงุช:</strong> ${suggestion.main_notes}
                        </p>
                        
                        <p class="mb-2" style="font-size: 0.9rem;">
                            <i class="bi bi-bucket text-secondary me-1"></i>
                            <strong>ุงูุชุฑููุฒ:</strong> ${suggestion.concentration} | 
                            <strong>ูุซุงูู ูู:</strong> ${suggestion.ideal_for}
                        </p>
                    </div>
                </div>
            `;
        });
        
        suggestionsContainer.innerHTML = html;
    })
    .catch(err => {
        console.error('Error fetching suggestions:', err);
        const suggestionsContainer = document.getElementById('ai-suggestions');
        suggestionsContainer.innerHTML = '<p class="text-danger text-center">ุญุฏุซ ุฎุทุฃ ูู ุฌูุจ ุงูููุชุฑุญุงุช</p>';
    });
}
</script>

<style>
.text-rose { color: #0B2E8A; }
.text-amber { color: #4F7DFF; }
.text-plum { color: #0B2E8A; }
</style>
{% endblock %}
