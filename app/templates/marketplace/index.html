{% extends "base.html" %}
{% block title %}سوق العطور{% endblock %}
{% block content %}
<div class="page-header text-center">
    <div class="container">
        <h1><i class="bi bi-shop me-2"></i>سوق العطور العالمي</h1>
        <p class="opacity-75">عطور حقيقية من متاجر عالمية موثوقة - روابط شراء مباشرة</p>
    </div>
</div>
<div class="container py-5">
    <div class="row">
        <div class="col-lg-3">
            <div class="card rounded-4 border-0 shadow-sm mb-4" style="background: rgba(255, 255, 255, 0.95);">
                <div class="card-body">
                    <h5 class="fw-bold mb-4"><i class="bi bi-search me-2" style="color: var(--velvet-plum);"></i>بحث ذكي</h5>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">ابحث عن عطر</label>
                        <input type="text" class="form-control rounded-3" id="search-query" 
                               placeholder="مثال: عود، ورد، توم فورد..." 
                               style="border: 2px solid var(--blush-rose);">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">الفئة</label>
                        <select class="form-select rounded-3" id="category-filter" style="border: 2px solid var(--blush-rose);">
                            <option value="all">جميع الفئات</option>
                            <option value="عطور نسائية">عطور نسائية</option>
                            <option value="عطور رجالية">عطور رجالية</option>
                            <option value="عطور يونيسكس">عطور يونيسكس</option>
                            <option value="زيوت">زيوت عطرية</option>
                            <option value="نوتات">نوتات ومواد خام</option>
                            <option value="عبوات">عبوات وزجاجات</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold">نطاق السعر</label>
                        <select class="form-select rounded-3" id="price-filter" style="border: 2px solid var(--blush-rose);">
                            <option value="all">جميع الأسعار</option>
                            <option value="budget">اقتصادي (أقل من $50)</option>
                            <option value="mid">متوسط ($50-$150)</option>
                            <option value="luxury">فاخر (أكثر من $150)</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-gradient w-100 rounded-pill fw-bold" id="search-btn">
                        <i class="bi bi-search me-2"></i>بحث
                    </button>
                    
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="bi bi-shield-check me-1" style="color: var(--velvet-plum);"></i>
                            منتجات حقيقية 100%
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="card rounded-4 border-0 shadow-sm" style="background: linear-gradient(135deg, rgba(233, 201, 211, 0.3) 0%, rgba(247, 244, 246, 0.5) 100%);">
                <div class="card-body">
                    <h6 class="fw-bold mb-3"><i class="bi bi-globe2 me-2" style="color: var(--warm-amber);"></i>متاجر موثوقة</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge rounded-pill" style="background: var(--velvet-plum);">Sephora</span>
                        <span class="badge rounded-pill" style="background: var(--warm-amber);">FragranceNet</span>
                        <span class="badge rounded-pill" style="background: var(--velvet-plum);">Nordstrom</span>
                        <span class="badge rounded-pill" style="background: var(--warm-amber);">Ulta Beauty</span>
                        <span class="badge rounded-pill" style="background: var(--velvet-plum);">Arabian Oud</span>
                        <span class="badge rounded-pill" style="background: var(--warm-amber);">Amazon</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-9">
            <div id="search-summary" class="mb-4">
                <div class="alert rounded-4 border-0" style="background: linear-gradient(135deg, rgba(233, 201, 211, 0.4) 0%, rgba(217, 163, 95, 0.2) 100%);">
                    <i class="bi bi-check-circle-fill me-2" style="color: var(--velvet-plum);"></i>
                    <span id="summary-text">منتجات مميزة من متاجر عالمية موثوقة</span>
                </div>
            </div>
            
            <div id="loading-state" style="display: none;">
                <div class="text-center py-5">
                    <div class="spinner-border mb-3" role="status" style="color: var(--velvet-plum); width: 3rem; height: 3rem;">
                        <span class="visually-hidden">جاري البحث...</span>
                    </div>
                    <h5 class="text-muted">جاري البحث...</h5>
                </div>
            </div>
            
            <div id="products-grid" class="row g-4">
                {% for product in featured_products %}
                <div class="col-md-6 col-lg-4">
                    <div class="card rounded-4 border-0 shadow-sm h-100 product-card" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(247, 244, 246, 0.95) 100%); transition: all 0.3s ease;">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="badge rounded-pill" style="background: var(--velvet-plum);">{{ product.category }}</span>
                                <span class="fs-3">{{ product.image_placeholder }}</span>
                            </div>
                            
                            <h5 class="fw-bold mb-1" style="color: var(--deep-black);">{{ product.name }}</h5>
                            <p class="mb-2" style="color: var(--velvet-plum); font-weight: 600;">{{ product.brand }}</p>
                            
                            <p class="text-muted small mb-3">{{ product.description }}</p>
                            
                            <div class="mb-2">
                                <small class="text-muted"><i class="bi bi-droplet me-1"></i>{{ product.main_notes }}</small>
                            </div>
                            
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <span class="badge rounded-pill bg-light text-dark">{{ product.concentration }}</span>
                                <span class="badge rounded-pill bg-light text-dark">{{ product.size }}</span>
                            </div>
                            
                            <div class="mb-3">
                                {% for i in range(5) %}
                                    {% if i < product.rating|int %}
                                        <i class="bi bi-star-fill text-warning"></i>
                                    {% elif i < product.rating %}
                                        <i class="bi bi-star-half text-warning"></i>
                                    {% else %}
                                        <i class="bi bi-star text-warning"></i>
                                    {% endif %}
                                {% endfor %}
                                <small class="text-muted ms-1">({{ product.rating }})</small>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <span class="fw-bold fs-4" style="color: var(--velvet-plum);">{{ product.price }}</span>
                                    {% if product.original_price %}
                                    <span class="text-muted text-decoration-line-through ms-2 small">{{ product.original_price }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <i class="bi bi-shop" style="color: var(--warm-amber);"></i>
                                <small class="fw-bold">{{ product.store_name }}</small>
                            </div>
                        </div>
                        
                        <div class="card-footer bg-transparent border-0 pt-0 p-4">
                            <a href="{{ product.store_url }}" target="_blank" rel="noopener noreferrer" 
                               class="btn w-100 rounded-pill fw-bold" 
                               style="background: linear-gradient(135deg, var(--velvet-plum) 0%, var(--warm-amber) 100%); color: white; border: none;">
                                <i class="bi bi-bag-check me-2"></i>اشتري من {{ product.store_name }}
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function showLoading() {
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('products-grid').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('products-grid').style.display = 'flex';
}

function renderStars(rating) {
    const fullStars = Math.floor(rating);
    const hasHalf = rating % 1 >= 0.5;
    let stars = '';
    for (let i = 0; i < fullStars; i++) {
        stars += '<i class="bi bi-star-fill text-warning"></i>';
    }
    if (hasHalf) {
        stars += '<i class="bi bi-star-half text-warning"></i>';
    }
    for (let i = fullStars + (hasHalf ? 1 : 0); i < 5; i++) {
        stars += '<i class="bi bi-star text-warning"></i>';
    }
    return stars;
}

function loadProducts() {
    const query = document.getElementById('search-query').value;
    const category = document.getElementById('category-filter').value;
    const price = document.getElementById('price-filter').value;
    
    showLoading();
    
    fetch('{{ url_for("marketplace.search") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            query: query,
            category: category, 
            price_range: price
        })
    })
    .then(r => r.json())
    .then(result => {
        hideLoading();
        const grid = document.getElementById('products-grid');
        const summaryText = document.getElementById('summary-text');
        
        if (result.search_summary) {
            summaryText.textContent = result.search_summary;
        }
        
        if (!result.products || result.products.length === 0) {
            grid.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-emoji-frown fs-1" style="color: var(--blush-rose);"></i>
                    <h5 class="mt-3">لم يتم العثور على منتجات</h5>
                    <p class="text-muted">جرب كلمات بحث مختلفة أو غير الفلاتر</p>
                </div>`;
            return;
        }
        
        grid.innerHTML = result.products.map(p => `
            <div class="col-md-6 col-lg-4">
                <div class="card rounded-4 border-0 shadow-sm h-100 product-card" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(247, 244, 246, 0.95) 100%); transition: all 0.3s ease;">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <span class="badge rounded-pill" style="background: var(--velvet-plum);">${p.category || 'عطور'}</span>
                            <span class="fs-3">${p.image_placeholder || '✨'}</span>
                        </div>
                        
                        <h5 class="fw-bold mb-1" style="color: var(--deep-black);">${p.name}</h5>
                        <p class="mb-2" style="color: var(--velvet-plum); font-weight: 600;">${p.brand}</p>
                        
                        <p class="text-muted small mb-3">${p.description || ''}</p>
                        
                        <div class="mb-2">
                            <small class="text-muted"><i class="bi bi-droplet me-1"></i>${p.main_notes || ''}</small>
                        </div>
                        
                        <div class="d-flex align-items-center gap-2 mb-3">
                            <span class="badge rounded-pill bg-light text-dark">${p.concentration || ''}</span>
                            <span class="badge rounded-pill bg-light text-dark">${p.size || ''}</span>
                        </div>
                        
                        <div class="mb-3">
                            ${renderStars(p.rating || 4.5)}
                            <small class="text-muted ms-1">(${p.rating || 4.5})</small>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <span class="fw-bold fs-4" style="color: var(--velvet-plum);">${p.price}</span>
                                ${p.original_price ? `<span class="text-muted text-decoration-line-through ms-2 small">${p.original_price}</span>` : ''}
                            </div>
                        </div>
                        
                        <div class="d-flex align-items-center gap-2 mb-3">
                            <i class="bi bi-shop" style="color: var(--warm-amber);"></i>
                            <small class="fw-bold">${p.store_name || 'متجر عالمي'}</small>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-transparent border-0 pt-0 p-4">
                        <a href="${p.store_url || '#'}" target="_blank" rel="noopener noreferrer" 
                           class="btn w-100 rounded-pill fw-bold" 
                           style="background: linear-gradient(135deg, var(--velvet-plum) 0%, var(--warm-amber) 100%); color: white; border: none;">
                            <i class="bi bi-bag-check me-2"></i>اشتري من ${p.store_name || 'المتجر'}
                        </a>
                    </div>
                </div>
            </div>
        `).join('');
    })
    .catch(error => {
        hideLoading();
        const grid = document.getElementById('products-grid');
        grid.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-exclamation-triangle fs-1 text-warning"></i>
                <h5 class="mt-3">حدث خطأ أثناء البحث</h5>
                <p class="text-muted">يرجى المحاولة مرة أخرى</p>
            </div>`;
    });
}

document.getElementById('search-btn').addEventListener('click', loadProducts);

document.getElementById('search-query').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        loadProducts();
    }
});
</script>

<style>
.product-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(179, 122, 148, 0.2) !important;
}

.product-card .btn:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 20px rgba(179, 122, 148, 0.3);
}

#search-query:focus,
#category-filter:focus,
#price-filter:focus {
    border-color: var(--velvet-plum) !important;
    box-shadow: 0 0 0 0.25rem rgba(179, 122, 148, 0.25);
}
</style>
{% endblock %}
