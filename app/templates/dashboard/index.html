{% extends "base.html" %}

{% block title %}ููุญุฉ ุงูุชุญูู{% endblock %}

{% block content %}
<div class="page-header text-center">
    <div class="container">
        <h1><i class="bi bi-person-circle me-2"></i> ูุฑุญุจุงู {{ current_user.name }}</h1>
        <p class="opacity-75">ุฅุฏุงุฑุฉ ูููู ุงูุนุทุฑู ุงูุดุฎุตู</p>
    </div>
</div>

<div class="container py-5">
    {% if daily_suggestion and daily_suggestion.success %}
    <div class="alert alert-info border-0 shadow-sm mb-5 rounded-4" style="background: linear-gradient(135deg, #4F7DFF 0%, #0B2E8A 100%); border-left: 5px solid #071F5E;">
        <div class="alert-body text-white">
            <div class="d-flex align-items-start">
                <i class="bi bi-flower1 fs-5 me-3 mt-1" style="flex-shrink: 0;"></i>
                <div>
                    <h5 class="fw-bold mb-2">๐ฟ ุงูุชุฑุงุญู ุงูุนุทุฑู ุงูููู</h5>
                    <p class="mb-2"><strong>{{ daily_suggestion.perfume_name }}</strong></p>
                    <p class="mb-3 small opacity-90">{{ daily_suggestion.description }}</p>
                    <p class="mb-0 small" style="opacity: 0.85;"><em>{{ daily_suggestion.reasoning }}</em></p>
                </div>
            </div>
        </div>
    </div>
    {% elif not analysis_results %}
    <div class="alert alert-warning border-0 shadow-sm mb-5 rounded-4" style="background: linear-gradient(135deg, #FFB347 0%, #FF8C00 100%); border-left: 5px solid #FF6347;">
        <div class="alert-body text-white">
            <div class="d-flex align-items-start">
                <i class="bi bi-star fs-5 me-3 mt-1" style="flex-shrink: 0;"></i>
                <div>
                    <h5 class="fw-bold mb-2">โจ ุงุจุฏุฃ ุฑุญูุชู ุงูุนุทุฑูุฉ</h5>
                    <p class="mb-2">ูู ุชูู ุจุฃู ุชุญูููุงุช ุจุนุฏ. ูู ุจุฅุฌุฑุงุก ุจุนุถ ุงูุชุญูููุงุช ููุชููู ูู ุชูุฏูู ุงูุชุฑุงุญุงุช ุนุทุฑูุฉ ูุฎุตุตุฉ ูู!</p>
                    <div>
                        <a href="{{ url_for('scent_dna.form') }}" class="btn btn-light btn-sm">
                            <i class="bi bi-play-circle me-1"></i> ุงุจุฏุฃ ุจู Scent DNA
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card stat-card-blush">
                <div class="stat-number">{{ stats.profiles_count }}</div>
                <div class="stat-label">ุชุญูููุงุช Scent DNA</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card stat-card-amber">
                <div class="stat-number">{{ stats.perfumes_count }}</div>
                <div class="stat-label">ุนุทูุฑ ูุตููุฉ</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card stat-card-plum">
                <div class="stat-number">{{ stats.recommendations_count }}</div>
                <div class="stat-label">ุชูุตูุงุช ูุญููุธุฉ</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #F2F4F8, #0B2E8A);">
                <div class="stat-number">{{ stats.analysis_count }}</div>
                <div class="stat-label">ุชุญูููุงุช ูุงููุฉ</div>
            </div>
        </div>
    </div>
    
    <div class="row g-4 mb-5">
        <div class="col-md-6">
            <div class="scent-dna-card">
                <div class="scent-dna-header">
                    <div class="scent-dna-icon">
                        <i class="bi bi-fingerprint"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold mb-0">ุขุฎุฑ ุชุญููู Scent DNA</h5>
                        <p class="small text-muted mb-0">ุงูุชุดู ุดุฎุตูุชู ุงูุนุทุฑูุฉ</p>
                    </div>
                </div>
                
                {% if latest_profile %}
                <div class="scent-dna-content">
                    <div class="scent-personality">
                        <span class="personality-badge-lg">{{ latest_profile.scent_personality or 'ุดุฎุตูุฉ ุนุทุฑูุฉ' }}</span>
                    </div>
                    <div class="profile-meta">
                        <small class="text-muted d-block">ุชุงุฑูุฎ ุงูุชุญููู: {{ latest_profile.created_at.strftime('%Y-%m-%d') }}</small>
                        {% if latest_profile.favorite_notes %}
                        <small class="text-muted d-block">ุงูููุชุงุช ุงูููุถูุฉ: {{ latest_profile.favorite_notes[:30] }}</small>
                        {% endif %}
                    </div>
                    <a href="{{ url_for('scent_dna.result', id=latest_profile.id) }}" class="btn btn-gradient btn-sm w-100">
                        <i class="bi bi-arrow-right me-1"></i> ุนุฑุถ ุงูุชูุงุตูู
                    </a>
                </div>
                {% else %}
                <div class="scent-dna-empty">
                    <p class="text-center text-muted mb-0">ูู ุชูู ุจุฃู ุชุญููู ุจุนุฏ</p>
                </div>
                {% endif %}
                
                <a href="{{ url_for('scent_dna.form') }}" class="btn btn-outline-gradient btn-sm w-100">
                    <i class="bi bi-plus me-1"></i> ุงุจุฏุฃ ุชุญููู ุฌุฏูุฏ
                </a>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="dashboard-card">
                <h5 class="fw-bold mb-3">
                    <i class="bi bi-palette text-danger me-2"></i>
                    ุขุฎุฑ ุนุทุฑ ูุตูู
                </h5>
                {% if latest_perfume %}
                <div class="bg-light rounded-4 p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-bold mb-1">{{ latest_perfume.name }}</h6>
                            <small class="text-muted">{{ latest_perfume.created_at.strftime('%Y-%m-%d') }}</small>
                        </div>
                        <a href="{{ url_for('custom_perfume.result', id=latest_perfume.id) }}" class="btn btn-outline-primary btn-sm">ุนุฑุถ</a>
                    </div>
                </div>
                {% else %}
                <p class="text-muted">ูู ุชุตูู ุฃู ุนุทุฑ ุจุนุฏ</p>
                {% endif %}
                <a href="{{ url_for('custom_perfume.form') }}" class="btn btn-gradient btn-gradient-secondary btn-sm">
                    <i class="bi bi-plus me-1"></i> ุตููู ุนุทุฑุงู ุฌุฏูุฏุงู
                </a>
            </div>
        </div>
    </div>
    
    {% if scent_profiles %}
    <div class="dashboard-card mb-4">
        <h5 class="fw-bold mb-3">
            <i class="bi bi-list-ul me-2"></i>
            ุณุฌู ุชุญูููุงุช Scent DNA
        </h5>
        <div class="table-responsive">
            <table class="table table-modern">
                <thead>
                    <tr>
                        <th>ุงูุดุฎุตูุฉ ุงูุนุทุฑูุฉ</th>
                        <th>ุงูููุชุงุช ุงูููุถูุฉ</th>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ุฅุฌุฑุงุกุงุช</th>
                    </tr>
                </thead>
                <tbody>
                    {% for profile in scent_profiles[:5] %}
                    <tr>
                        <td>{{ profile.scent_personality or 'ุบูุฑ ูุญุฏุฏ' }}</td>
                        <td>{{ profile.favorite_notes[:40] }}...</td>
                        <td>{{ profile.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <a href="{{ url_for('scent_dna.result', id=profile.id) }}" class="btn btn-sm btn-outline-primary">ุนุฑุถ</a>
                            <a href="{{ url_for('custom_perfume.form', scent_profile_id=profile.id) }}" class="btn btn-sm btn-outline-secondary">ุตููู ุนุทุฑุงู</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    {% if custom_perfumes %}
    <div class="dashboard-card">
        <h5 class="fw-bold mb-3">
            <i class="bi bi-collection me-2"></i>
            ุณุฌู ุงูุนุทูุฑ ุงููุตููุฉ
        </h5>
        <div class="table-responsive">
            <table class="table table-modern">
                <thead>
                    <tr>
                        <th>ุงุณู ุงูุนุทุฑ</th>
                        <th>ุงูููุงุณุจุฉ</th>
                        <th>ูุณุจุฉ ุงูุชูุงูู</th>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ุฅุฌุฑุงุกุงุช</th>
                    </tr>
                </thead>
                <tbody>
                    {% for perfume in custom_perfumes[:5] %}
                    <tr>
                        <td>{{ perfume.name }}</td>
                        <td>{{ perfume.occasion }}</td>
                        <td><span class="badge bg-primary">{{ perfume.match_score | int }}%</span></td>
                        <td>{{ perfume.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <a href="{{ url_for('custom_perfume.result', id=perfume.id) }}" class="btn btn-sm btn-outline-primary">ุนุฑุถ</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    {% if analysis_results %}
    <div class="dashboard-card mt-4">
        <h5 class="fw-bold mb-3">
            <i class="bi bi-clock-history me-2"></i>
            ุณุฌู ุงูุชุญูููุงุช
        </h5>
        <p class="text-muted small mb-3">ุฌููุน ูุชุงุฆุฌ ุงูุชุญูููุงุช ูู ุงููุญุฏุงุช ุงููุฎุชููุฉ</p>
        <div class="row g-3">
            {% for analysis in analysis_results[:12] %}
            <div class="col-md-4">
                <div class="analysis-card p-3 rounded-4 bg-light border-0 h-100" style="cursor: pointer;" onclick="showAnalysisModal({{ analysis.id }})">
                    <div class="d-flex align-items-center mb-2">
                        <div class="analysis-icon me-2" style="width: 40px; height: 40px; background: linear-gradient(135deg, #F2F4F8, #0B2E8A); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi {{ analysis.module_icon or 'bi-star' }} text-white"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold" style="font-size: 0.9rem;">{{ analysis.module_name_ar or analysis.module_type }}</h6>
                            <small class="text-muted">{{ analysis.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <span class="badge" style="background-color: #0B2E8A;">ุนุฑุถ ุงูุชูุงุตูู</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if analysis_results|length > 12 %}
        <div class="text-center mt-4">
            <a href="{{ url_for('dashboard.all_analyses') }}" class="btn btn-outline-gradient">
                <i class="bi bi-grid me-1"></i> ุนุฑุถ ูู ุงูุชุญูููุงุช ({{ analysis_results|length }})
            </a>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="dashboard-card mt-4">
        <h5 class="fw-bold mb-3">
            <i class="bi bi-clock-history me-2"></i>
            ุณุฌู ุงูุชุญูููุงุช
        </h5>
        <div class="text-center py-4">
            <i class="bi bi-inbox display-4 text-muted"></i>
            <p class="text-muted mt-3">ูู ุชูู ุจุฃู ุชุญูููุงุช ุจุนุฏ</p>
            <a href="{{ url_for('main.modules') }}" class="btn btn-gradient">
                <i class="bi bi-grid me-1"></i> ุงุจุฏุฃ ุชุญูููุงู ุฌุฏูุฏุงู
            </a>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="analysisModal" tabindex="-1" aria-labelledby="analysisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content" style="border-radius: 25px; border: none;">
            <div class="modal-header" style="background: linear-gradient(135deg, #F2F4F8, #0B2E8A); border-radius: 25px 25px 0 0; border: none;">
                <h5 class="modal-title text-white" id="analysisModalLabel">
                    <i class="bi bi-file-earmark-text me-2"></i>ุชูุงุตูู ุงูุชุญููู
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="analysisModalBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ุฌุงุฑู ุงูุชุญููู...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border: none;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 15px;">ุฅุบูุงู</button>
            </div>
        </div>
    </div>
</div>

<script>
function showAnalysisModal(analysisId) {
    const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
    modal.show();
    
    document.getElementById('analysisModalBody').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border" style="color: #0B2E8A;" role="status">
                <span class="visually-hidden">ุฌุงุฑู ุงูุชุญููู...</span>
            </div>
        </div>
    `;
    
    fetch(`/dashboard/api/analysis/${analysisId}`)
        .then(response => response.json())
        .then(data => {
            let html = `
                <div class="mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="analysis-icon me-3" style="width: 50px; height: 50px; background: linear-gradient(135deg, #F2F4F8, #0B2E8A); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi ${data.module_icon || 'bi-star'} text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0 fw-bold">${data.module_name_ar || data.module_type}</h5>
                            <small class="text-muted">${data.created_at}</small>
                        </div>
                    </div>
                </div>
            `;
            
            if (data.result_data) {
                html += '<div class="bg-light rounded-4 p-4">';
                html += '<h6 class="fw-bold mb-3" style="color: #0B2E8A;"><i class="bi bi-clipboard-data me-2"></i>ูุชุงุฆุฌ ุงูุชุญููู</h6>';
                html += renderJsonData(data.result_data);
                html += '</div>';
            }
            
            document.getElementById('analysisModalBody').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('analysisModalBody').innerHTML = `
                <div class="text-center py-5 text-danger">
                    <i class="bi bi-exclamation-triangle display-4"></i>
                    <p class="mt-3">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช</p>
                </div>
            `;
        });
}

function renderJsonData(data) {
    if (typeof data === 'string') {
        return `<p>${data}</p>`;
    }
    
    if (Array.isArray(data)) {
        return '<ul class="list-unstyled mb-0">' + data.map(item => {
            if (typeof item === 'object') {
                return '<li class="mb-2 p-2 bg-white rounded-3">' + renderJsonData(item) + '</li>';
            }
            return `<li class="mb-1"><i class="bi bi-check2 me-2" style="color: #0B2E8A;"></i>${item}</li>`;
        }).join('') + '</ul>';
    }
    
    if (typeof data === 'object' && data !== null) {
        let html = '<div class="row g-2">';
        for (const [key, value] of Object.entries(data)) {
            if (typeof value === 'object' && value !== null) {
                html += `<div class="col-12 mb-2">
                    <strong class="d-block mb-1" style="color: #1F1F1F;">${formatKey(key)}</strong>
                    <div class="ps-3">${renderJsonData(value)}</div>
                </div>`;
            } else {
                html += `<div class="col-md-6 col-12">
                    <div class="p-2 bg-white rounded-3">
                        <small class="text-muted d-block">${formatKey(key)}</small>
                        <span class="fw-medium">${value || '-'}</span>
                    </div>
                </div>`;
            }
        }
        html += '</div>';
        return html;
    }
    
    return `<span>${data}</span>`;
}

function formatKey(key) {
    const translations = {
        'suitable_perfumes': 'ุงูุนุทูุฑ ุงูููุงุณุจุฉ',
        'stability_level': 'ูุณุชูู ุงูุซุจุงุช',
        'avoid_ingredients': 'ุงูููููุงุช ุงููุชุฌูุจุฉ',
        'recommendations': 'ุงูุชูุตูุงุช',
        'volatility_rate': 'ูุนุฏู ุงูุชุทุงูุฑ',
        'hot_weather_stability': 'ุงูุซุจุงุช ูู ุงูุญุฑ',
        'cold_weather_stability': 'ุงูุซุจุงุช ูู ุงูุจุฑุฏ',
        'best_time': 'ุฃูุถู ููุช',
        'recommended_concentration': 'ุงูุชุฑููุฒ ุงูููุงุณุจ',
        'tips': 'ูุตุงุฆุญ',
        'metabolism_type': 'ููุน ุงูุฃูุถ',
        'strong_perfumes': 'ุงูุนุทูุฑ ุงููููุฉ',
        'soft_perfumes': 'ุงูุนุทูุฑ ุงูุฎูููุฉ',
        'stability_factors': 'ุนูุงูู ุงูุซุจุงุช',
        'recommendation': 'ุงูุชูุตูุฉ',
        'summer_perfumes': 'ุนุทูุฑ ุงูุตูู',
        'winter_perfumes': 'ุนุทูุฑ ุงูุดุชุงุก',
        'sillage_level': 'ูุณุชูู ุงูููุญุงู',
        'hot_weather_options': 'ุฎูุงุฑุงุช ุงูุญุฑ',
        'neural_profile': 'ุงูููู ุงูุนุตุจู',
        'mood_recommendations': 'ุชูุตูุงุช ุงููุฒุงุฌ',
        'emotional_notes': 'ุงูููุชุงุช ุงูุนุงุทููุฉ',
        'color_scent_match': 'ุชุทุงุจู ุงูููู ูุงูุฑุงุฆุญุฉ',
        'memory_triggers': 'ูุญูุฒุงุช ุงูุฐุงูุฑุฉ',
        'recommended_perfumes': 'ุงูุนุทูุฑ ุงูููุตู ุจูุง',
        'stability_score': 'ุฏุฑุฌุฉ ุงูุซุจุงุช',
        'sillage_strength': 'ููุฉ ุงูููุญุงู',
        'longevity_hours': 'ุณุงุนุงุช ุงูุซุจุงุช',
        'best_application': 'ุฃูุถู ุทุฑููุฉ ููุฑุด',
        'future_top5': 'ุฃูุถู 5 ูุณุชูุจููุฉ',
        'taste_patterns': 'ุฃููุงุท ุงูุฐูู',
        'evolution_analysis': 'ุชุญููู ุงูุชุทูุฑ',
        'next_purchase': 'ุงูุดุฑุงุก ุงููุงุฏู',
        'personality_description': 'ูุตู ุงูุดุฎุตูุฉ',
        'strengths': 'ููุงุท ุงูููุฉ',
        'scent_colors': 'ุฃููุงู ุงูุนุทุฑ',
        'mood_board': 'ููุญุฉ ุงููุฒุงุฌ',
        'identity_statement': 'ุจูุงู ุงููููุฉ',
        'signature_name': 'ุงุณู ุงูุนุทุฑ ุงูุชูููุนู',
        'description': 'ุงููุตู',
        'notes': 'ุงูููุชุงุช',
        'wearing_guide': 'ุฏููู ุงูุงุฑุชุฏุงุก',
        'uniqueness': 'ุงูุชูุฑุฏ',
        'perfumes': 'ุงูุนุทูุฑ',
        'weekly_plan': 'ุงูุฎุทุฉ ุงูุฃุณุจูุนูุฉ',
        'monthly_tips': 'ูุตุงุฆุญ ุดูุฑูุฉ',
        'digital_identity': 'ุงููููุฉ ุงูุฑูููุฉ',
        'permanent_record': 'ุงูุณุฌู ุงูุฏุงุฆู',
        'auto_updates': 'ุงูุชุญุฏูุซ ุงูุชููุงุฆู',
        'last_updated': 'ุขุฎุฑ ุชุญุฏูุซ',
        'evolution_stage': 'ูุฑุญูุฉ ุงูุชุทูุฑ',
        'current_recommendation': 'ุงูุชูุตูุฉ ุงูุญุงููุฉ',
        'morning_perfume': 'ุนุทุฑ ุงูุตุจุงุญ',
        'evening_perfume': 'ุนุทุฑ ุงููุณุงุก',
        'adaptive_tips': 'ูุตุงุฆุญ ุชูููููุฉ',
        'accord_name': 'ุงุณู ุงูุฃููุฑุฏ',
        'notes_used': 'ุงูููุชุงุช ุงููุณุชุฎุฏูุฉ',
        'mixing_ratios': 'ูุณุจ ุงููุฒุฌ',
        'layer_type': 'ููุน ุงูุทุจูุฉ',
        'compatibility': 'ุงูุชูุงูู',
        'name': 'ุงูุงุณู',
        'price': 'ุงูุณุนุฑ',
        'why': 'ุงูุณุจุจ',
        'match': 'ุงูุชุทุงุจู',
        'category': 'ุงููุฆุฉ',
        'perfume': 'ุงูุนุทุฑ',
        'reason': 'ุงูุณุจุจ',
        'type': 'ุงูููุน',
        'best_for': 'ุงูุฃูุถู ูู',
        'time_period': 'ุงููุชุฑุฉ ุงูุฒูููุฉ',
        'top': 'ุงูููุฏูุฉ',
        'heart': 'ุงูููุจ',
        'base': 'ุงููุงุนุฏุฉ',
        'occasion': 'ุงูููุงุณุจุฉ',
        'application': 'ุงูุทุฑููุฉ',
        'layering': 'ุงูุทุจูุงุช',
        'primary': 'ุฃุณุงุณู',
        'secondary': 'ุซุงููู',
        'accent': 'ููุณุฉ',
        'vibes': 'ุงูุฃุฌูุงุก',
        'occasions': 'ุงูููุงุณุจุงุช',
        'seasons': 'ุงูููุงุณู',
        'time': 'ุงูููุช',
        'code': 'ุงูููุฏ',
        'personality_type': 'ููุน ุงูุดุฎุตูุฉ',
        'scent_family': 'ุนุงุฆูุฉ ุงูุนุทุฑ',
        'favorite_notes': 'ุงูููุชุงุช ุงูููุถูุฉ',
        'preferred_intensity': 'ุดุฏุฉ ุงูุชุฑููุฒ',
        'best_season': 'ุฃูุถู ููุณู',
        'signature_accords': 'ุงูุฃููุฑุฏุงุช ุงูุชูููุนูุฉ',
        'happiness': 'ุงูุณุนุงุฏุฉ',
        'calm': 'ุงููุฏูุก',
        'energy': 'ุงูุทุงูุฉ'
    };
    return translations[key] || key.replace(/_/g, ' ');
}
</script>
{% endblock %}
