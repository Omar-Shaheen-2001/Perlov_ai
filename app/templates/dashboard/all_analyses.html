{% extends "base.html" %}

{% block title %}كل التحليلات{% endblock %}

{% block content %}
<div class="page-header text-center">
    <div class="container">
        <h1><i class="bi bi-clock-history me-2"></i> سجل التحليلات الكامل</h1>
        <p class="opacity-75">جميع نتائج التحليلات من الوحدات المختلفة</p>
    </div>
</div>

<div class="container py-5">
    {% if analysis_results %}
    <div class="dashboard-card">
        <div class="row g-3">
            {% for analysis in analysis_results %}
            <div class="col-md-6 col-lg-4">
                <div class="analysis-card p-4 rounded-4 bg-light border-0 h-100" style="cursor: pointer; transition: all 0.3s ease;" onclick="showAnalysisModal({{ analysis.id }})" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 20px rgba(11, 46, 138, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div class="d-flex align-items-center mb-3">
                        <div class="analysis-icon me-3" style="width: 50px; height: 50px; background: linear-gradient(135deg, #F2F4F8, #0B2E8A); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="bi {{ analysis.module_icon or 'bi-star' }} text-white fs-5"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold" style="font-size: 1rem; color: #0B2E8A;">{{ analysis.module_name_ar or analysis.module_type }}</h6>
                            <small class="text-muted">{{ analysis.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small text-muted">اضغط لعرض التفاصيل</span>
                        <i class="bi bi-arrow-left text-primary"></i>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="dashboard-card text-center py-5">
        <i class="bi bi-inbox display-4 text-muted mb-3"></i>
        <h5 class="text-muted mt-3">لم تقم بأي تحليلات بعد</h5>
        <p class="text-muted small mb-3">ابدأ باستخدام أحد الوحدات لإجراء تحليلات</p>
        <a href="{{ url_for('main.modules') }}" class="btn btn-gradient">
            <i class="bi bi-grid me-1"></i> اذهب إلى الوحدات
        </a>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="analysisModal" tabindex="-1" aria-labelledby="analysisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content" style="border-radius: 25px; border: none;">
            <div class="modal-header" style="background: linear-gradient(135deg, #F2F4F8, #0B2E8A); border-radius: 25px 25px 0 0; border: none;">
                <h5 class="modal-title text-white" id="analysisModalLabel">
                    <i class="bi bi-file-earmark-text me-2"></i>تفاصيل التحليل
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="analysisModalBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border: none;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 15px;">إغلاق</button>
            </div>
        </div>
    </div>
</div>

<script>
function showAnalysisModal(analysisId) {
    const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
    modal.show();
    
    document.getElementById('analysisModalBody').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border" style="color: #0B2E8A;" role="status">
                <span class="visually-hidden">جاري التحميل...</span>
            </div>
        </div>
    `;
    
    fetch(`/dashboard/api/analysis/${analysisId}`)
        .then(response => response.json())
        .then(data => {
            let html = `
                <div class="mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="analysis-icon me-3" style="width: 50px; height: 50px; background: linear-gradient(135deg, #F2F4F8, #0B2E8A); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi ${data.module_icon || 'bi-star'} text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0 fw-bold">${data.module_name_ar || data.module_type}</h5>
                            <small class="text-muted">${data.created_at}</small>
                        </div>
                    </div>
                </div>
            `;
            
            if (data.result_data) {
                html += '<div class="bg-light rounded-4 p-4">';
                html += '<h6 class="fw-bold mb-3" style="color: #0B2E8A;"><i class="bi bi-clipboard-data me-2"></i>نتائج التحليل</h6>';
                html += renderJsonData(data.result_data);
                html += '</div>';
            }
            
            document.getElementById('analysisModalBody').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('analysisModalBody').innerHTML = `
                <div class="text-center py-5 text-danger">
                    <i class="bi bi-exclamation-triangle display-4"></i>
                    <p class="mt-3">حدث خطأ في تحميل البيانات</p>
                </div>
            `;
        });
}

function renderJsonData(data) {
    if (typeof data === 'string') {
        return `<p>${data}</p>`;
    }
    
    if (Array.isArray(data)) {
        return '<ul class="list-unstyled mb-0">' + data.map(item => {
            if (typeof item === 'object') {
                return '<li class="mb-2 p-2 bg-white rounded-3">' + renderJsonData(item) + '</li>';
            }
            return `<li class="mb-1"><i class="bi bi-check2 me-2" style="color: #0B2E8A;"></i>${item}</li>`;
        }).join('') + '</ul>';
    }
    
    if (typeof data === 'object' && data !== null) {
        let html = '<div class="row g-2">';
        for (const [key, value] of Object.entries(data)) {
            if (typeof value === 'object' && value !== null) {
                html += `<div class="col-12 mb-2">
                    <strong class="d-block mb-1" style="color: #1F1F1F;">${formatKey(key)}</strong>
                    <div class="ps-3">${renderJsonData(value)}</div>
                </div>`;
            } else {
                html += `<div class="col-md-6 col-12">
                    <div class="p-2 bg-white rounded-3">
                        <small class="text-muted d-block">${formatKey(key)}</small>
                        <span class="fw-medium">${value || '-'}</span>
                    </div>
                </div>`;
            }
        }
        html += '</div>';
        return html;
    }
    
    return `<span>${data}</span>`;
}

function formatKey(key) {
    const translations = {
        'suitable_perfumes': 'العطور المناسبة',
        'stability_level': 'مستوى الثبات',
        'avoid_ingredients': 'المكونات المتجنبة',
        'recommendations': 'التوصيات',
        'volatility_rate': 'معدل التطاير',
        'hot_weather_stability': 'الثبات في الحر',
        'cold_weather_stability': 'الثبات في البرد',
        'best_time': 'أفضل وقت',
        'recommended_concentration': 'التركيز المناسب',
        'tips': 'نصائح',
        'metabolism_type': 'نوع الأيض',
        'strong_perfumes': 'العطور القوية',
        'soft_perfumes': 'العطور الخفيفة',
        'stability_factors': 'عوامل الثبات',
        'recommendation': 'التوصية',
        'summer_perfumes': 'عطور الصيف',
        'winter_perfumes': 'عطور الشتاء',
        'sillage_level': 'مستوى الفوحان',
        'hot_weather_options': 'خيارات الحر',
        'neural_profile': 'الملف العصبي',
        'mood_recommendations': 'توصيات المزاج',
        'emotional_notes': 'النوتات العاطفية',
        'color_scent_match': 'تطابق اللون والرائحة',
        'memory_triggers': 'محفزات الذاكرة',
        'recommended_perfumes': 'العطور الموصى بها',
        'stability_score': 'درجة الثبات',
        'sillage_strength': 'قوة الفوحان',
        'longevity_hours': 'ساعات الثبات',
        'best_application': 'أفضل طريقة للرش',
        'future_top5': 'أفضل 5 مستقبلية',
        'taste_patterns': 'أنماط الذوق',
        'evolution_analysis': 'تحليل التطور',
        'next_purchase': 'الشراء القادم',
        'personality_description': 'وصف الشخصية',
        'strengths': 'نقاط القوة',
        'scent_colors': 'ألوان العطر',
        'mood_board': 'لوحة المزاج',
        'identity_statement': 'بيان الهوية',
        'signature_name': 'اسم العطر التوقيعي',
        'description': 'الوصف',
        'notes': 'النوتات',
        'wearing_guide': 'دليل الارتداء',
        'uniqueness': 'التفرد',
        'perfumes': 'العطور',
        'weekly_plan': 'الخطة الأسبوعية',
        'monthly_tips': 'نصائح شهرية',
        'digital_identity': 'الهوية الرقمية',
        'permanent_record': 'السجل الدائم',
        'auto_updates': 'التحديث التلقائي',
        'last_updated': 'آخر تحديث',
        'evolution_stage': 'مرحلة التطور',
        'current_recommendation': 'التوصية الحالية',
        'morning_perfume': 'عطر الصباح',
        'evening_perfume': 'عطر المساء',
        'adaptive_tips': 'نصائح تكيّفية',
        'accord_name': 'اسم الأكورد',
        'notes_used': 'النوتات المستخدمة',
        'mixing_ratios': 'نسب المزج',
        'layer_type': 'نوع الطبقة',
        'compatibility': 'التوافق',
        'name': 'الاسم',
        'price': 'السعر',
        'why': 'السبب',
        'match': 'التطابق',
        'category': 'الفئة',
        'perfume': 'العطر',
        'reason': 'السبب',
        'type': 'النوع',
        'best_for': 'الأفضل لـ',
        'time_period': 'الفترة الزمنية',
        'top': 'المقدمة',
        'heart': 'القلب',
        'base': 'القاعدة',
        'occasion': 'المناسبة',
        'application': 'الطريقة',
        'layering': 'الطبقات',
        'primary': 'أساسي',
        'secondary': 'ثانوي',
        'accent': 'لمسة',
        'vibes': 'الأجواء',
        'occasions': 'المناسبات',
        'seasons': 'المواسم',
        'time': 'الوقت',
        'code': 'الكود',
        'personality_type': 'نوع الشخصية',
        'scent_family': 'عائلة العطر',
        'favorite_notes': 'النوتات المفضلة',
        'preferred_intensity': 'شدة التركيز',
        'best_season': 'أفضل موسم',
        'signature_accords': 'الأكوردات التوقيعية',
        'happiness': 'السعادة',
        'calm': 'الهدوء',
        'energy': 'الطاقة',
        'dna_alignment': 'محاذاة DNA',
        'six_factor_analysis': 'تحليل 6 عوامل',
        'notes_match': 'تطابق النوتات',
        'family_match': 'تطابق العائلة',
        'style_match': 'تطابق الأسلوب',
        'character_match': 'تطابق الطابع',
        'sillage_match': 'تطابق الفوحان',
        'mood_match': 'تطابق المزاج',
        'detailed_match_reason': 'سبب التطابق الشامل',
        'excluded_fragrances': 'العطور المستبعدة',
        'exclusion_reason': 'سبب الاستبعاد',
        'scientific_conclusion': 'الخلاصة العلمية',
        'dna_summary': 'ملخص DNA'
    };
    return translations[key] || key.replace(/_/g, ' ');
}
</script>
{% endblock %}
